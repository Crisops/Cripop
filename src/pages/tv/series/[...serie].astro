---
import Layout from '@/layouts/Layout.astro'
import type { DetailsSeries } from '@/types/details-serie'
import type { DetailsSeriesSeasons } from '@/types/database.types'
import type { Videos } from '@/types/videos'
import { tmdbUrls } from '@/services/tmdb/urls'
import axiosClient from '@/lib/axios/client'
import MediaDetails from '@/components/astro/media-details.astro'

const { serie } = Astro.params

if (!serie) return Astro.redirect('/404')

const [id, name] = serie.split('/')

const URL_SERIE_DETAILS = tmdbUrls.detailsWithVideos('tv', parseInt(id))
const URL_SERIE_VIDEOS = tmdbUrls.videos.all('tv', parseInt(id))
const [detailSerie, detailSerieVideos] = await Promise.all([
  axiosClient.get<DetailsSeries>(URL_SERIE_DETAILS),
  axiosClient.get<Videos>(URL_SERIE_VIDEOS),
])

if (!detailSerie.success || !detailSerieVideos.success) return Astro.redirect('/404')

const { data: dataSerie } = detailSerie
const { data: dataSerieVideos } = detailSerieVideos

const detailsSerie: Omit<DetailsSeriesSeasons, 'currentSeason'> = {
  ...dataSerie,
  runtime: dataSerie.episode_run_time[0] * dataSerie.number_of_episodes,
  videos: dataSerieVideos,
}
---

<Layout title={`Cripop - ${name}`}>
  <MediaDetails data={detailsSerie} type="tv" />
</Layout>
