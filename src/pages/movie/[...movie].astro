---
import Layout from '@/layouts/Layout.astro'
import type { DetailsMovieId } from '@/types/details-movie-id'
import type { Videos } from '@/types/videos'
import { tmdbUrls } from '@/services/tmdb/urls'
import axiosClient from '@/lib/axios/client'
import MediaDetails from '@/components/astro/media-details.astro'

const { movie } = Astro.params

if (!movie) return Astro.redirect('/404')

const [id, _] = movie.split('/')

const URL_MOVIE_DETAILS = tmdbUrls.detailsWithVideos('movie', parseInt(id))

const URL_MOVIE_VIDEOS = tmdbUrls.videos.all('movie', parseInt(id))

const [detailMovie, detailMovieVideos] = await Promise.all([
  axiosClient.get<DetailsMovieId>(URL_MOVIE_DETAILS),
  axiosClient.get<Videos>(URL_MOVIE_VIDEOS),
])

if (!detailMovie.success || !detailMovieVideos.success) return Astro.redirect('/404')

const { data: dataMovie } = detailMovie
const { data: dataMovieVideos } = detailMovieVideos

const data = {
  ...dataMovie,
  videos: dataMovieVideos,
}

const name = `${data.title} ${`(${new Date(data.release_date).getFullYear()})`}`
---

<Layout title={`${name} - Cripop`}>
  <MediaDetails data={data} type="movie" />
</Layout>
